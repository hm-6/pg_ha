scope: "{{ pg_cluster_scope }}"
namespace: "{{ pg_namespace }}"
name: "{{ patroni_name }}"

restapi:
  listen: "0.0.0.0:{{ patroni_rest_port }}"
  connect_address: "{{ patroni_ip }}:{{ patroni_rest_port }}"

{#raft:#}
{#  data_dir: /var/lib/postgresql/raft#}
{#  self_addr: "{{ patroni_ip }}:{{ patroni_raft_port }}"#}
{#  partner_addrs:#}
{#{% for host in groups['postgreses'] if host != inventory_hostname %}#}
{#    - "{{ hostvars[host].patroni_ip }}:{{ patroni_raft_port }}"#}
{#{% endfor %}#}

restapi:
  listen: "0.0.0.0:{{ patroni_rest_port }}"
  connect_address: "{{ patroni_ip }}:{{ patroni_rest_port }}"

{# --- DCS Auswahl: raft (default) oder etcd3 --- #}
{% if patroni_dcs_provider | default('raft') == 'raft' %}
raft:
  data_dir: /var/lib/postgresql/raft
  self_addr: "{{ patroni_ip }}:{{ patroni_raft_port }}"
  partner_addrs:
{% for host in groups['postgreses'] if host != inventory_hostname %}
    - "{{ hostvars[host].patroni_ip }}:{{ patroni_raft_port }}"
{% endfor %}
{% else %}
etcd:
  # Patroni erwartet "hosts" als Komma-separierte Liste
  hosts: "{{ patroni_etcd_endpoints }}"
{% endif %}

bootstrap:
  dcs:
    ttl: {{ patroni_dcs.ttl }}
    loop_wait: {{ patroni_dcs.loop_wait }}
    retry_timeout: {{ patroni_dcs.retry_timeout }}
    synchronous_mode: {{ patroni_dcs.synchronous_mode | bool | lower }}
    synchronous_mode_strict: {{ patroni_dcs.synchronous_mode_strict | bool | lower }}
    synchronous_node_count: {{ patroni_dcs.synchronous_node_count }}
    postgresql:
      parameters:
        max_connections: {{ patroni_dcs.postgresql.parameters.max_connections }}
        shared_buffers: "{{ patroni_dcs.postgresql.parameters.shared_buffers }}"
        wal_level: "{{ patroni_dcs.postgresql.parameters.wal_level }}"
        hot_standby: "{{ patroni_dcs.postgresql.parameters.hot_standby }}"
        hot_standby_feedback: "{{ patroni_dcs.postgresql.parameters.hot_standby_feedback }}"
        max_wal_senders: {{ patroni_dcs.postgresql.parameters.max_wal_senders }}
        max_replication_slots: {{ patroni_dcs.postgresql.parameters.max_replication_slots }}
        wal_keep_size: "{{ patroni_dcs.postgresql.parameters.wal_keep_size }}"
  initdb:
    - encoding: UTF8
    - data-checksums
  pg_hba:
    - "local   all             all                               peer"
    - "host    all             all           127.0.0.1/32        md5"
    - "host    all             all           ::1/128             md5"
    - "host    replication     {{ pg_replication.username }}     127.0.0.1/32        md5"
    - "host    replication     {{ pg_replication.username }}     {{ pg_cluster_cidr }}    md5"
    - "host    all             all           {{ pg_cluster_cidr }}    md5"

postgresql:
  listen: "0.0.0.0:{{ postgres_port }}"
  connect_address: "{{ patroni_ip }}:{{ postgres_port }}"
  data_dir: "/var/lib/postgresql/{{ pg_version }}/patroni"
  bin_dir: "/usr/lib/postgresql/{{ pg_version }}/bin"

  #  NEU: automatische Reparatur bei Timeline-Divergenz
  use_pg_rewind: true
  remove_data_directory_on_diverged_timelines: true
  # (Optional, aber empfehlenswert, falls du Slots nutzt)
  use_slots: true

  authentication:
    replication:
      username: "{{ pg_replication.username }}"
      password: "{{ pg_replication.password }}"
    superuser:
      username: "{{ pg_superuser.username }}"
      password: "{{ pg_superuser.password }}"
  parameters:
    unix_socket_directories: '/var/run/postgresql'
  pg_hba:
    - "local   all             all                                   trust"
    - "host    all             all                127.0.0.1/32       trust"
    - "host    all             all                ::1/128            trust"
    - "host    replication     {{ pg_replication.username }}         127.0.0.1/32       trust"
    - "host    replication     {{ pg_replication.username }}         ::1/128            trust"
    - "host    replication     {{ pg_replication.username }}         {{ pg_cluster_cidr }}   md5"
    - "host    all             all                                   {{ pg_cluster_cidr }}   md5"

tags:
  nofailover: false
  noloadbalance: false
  clonefrom: false
